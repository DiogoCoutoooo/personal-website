---
import Layout from '../../../layouts/Layout.astro';
import Header from '../../../components/Header.astro';
import Footer from '../../../components/Footer.astro';
import midiaData from '../../../data/midia.json';

// Sort media by ID
const sortedMidia = [...midiaData].sort((a, b) => a.id - b.id);
---

<Layout title="Ant√≥nio Abrantes ‚Äî Economista" description="Conte√∫do multim√©dia da obra Madrugada em Clave, Coluna da Harmonia.">
	<Header />
	
	<main class="livro-page">
		<section class="livro-hero">
			<div class="container">
				<h1>Madrugada em Clave</h1>
				<p class="eyebrow">Coluna da Harmonia</p>
				<p class="lead">Biblioteca multim√©dia: Explore os v√≠deos e √°udios que acompanham a obra.</p>
				
				<div class="search-container">
					<input type="text" id="mediaSearch" placeholder="Pesquisar por n√∫mero ou t√≠tulo..." aria-label="Pesquisar m√©dia" />
					<div class="controls-bar">
						<div class="view-toggles">
							<button class="filter-btn view-btn active" data-view="expanded">Expandido</button>
							<button class="filter-btn view-btn" data-view="compact">Compacto</button>
						</div>
						<span class="separator">|</span>
						<div class="filters">
							<button class="filter-btn active" data-type="all">Todos</button>
							<button class="filter-btn" data-type="video">V√≠deos</button>
							<button class="filter-btn" data-type="audio">√Åudios</button>
							<button class="filter-btn" data-type="album">√Ålbuns</button>
						</div>
					</div>
				</div>
			</div>
		</section>

		<section class="media-section">
			<div class="container">
				<div id="mediaGrid" class="media-grid">
					{sortedMidia.map((item) => (
						<article 
							class="media-card" 
							data-id={item.id} 
							data-type={item.type} 
							data-title={item.title.toLowerCase()}
							id={`item-${item.id}`}
						>
							<div class="card-image">
								{item.cover ? (
									<img src={item.cover} alt={item.title} loading="lazy" />
								) : item.type === 'video' ? (
									<video 
										data-src={(item.filename || '').startsWith('http') ? `${item.filename}#t=0.1` : `/livro_media/${item.filename}#t=0.1`} 
										preload="metadata" 
										muted 
										playsinline
										class="thumbnail-video lazy-video"
									></video>
								) : (
									<div class="placeholder-icon">
										{item.type === 'video' ? 'üé¨' : item.type === 'album' ? 'üóÇÔ∏è' : 'üéµ'}
									</div>
								)}
							</div>
							<div class="media-info">
								<span class="media-number">#{item.id}</span>
								<h3 class="media-title">{item.title}</h3>
								<div class="media-footer">
									<span class={`type-badge ${item.type}`}>
										{item.type === 'video' ? 'üì∫ V√≠deo' : item.type === 'album' ? 'üóÇÔ∏è √Ålbum' : 'üéµ √Åudio'}
									</span>
									<!-- Hidden metadata for JS interaction -->
									<span class="media-data hidden" data-item={JSON.stringify(item)}></span>
								</div>
							</div>
						</article>
					))}
				</div>
				<div id="noResults" class="no-results hidden">
					<p>Nenhum resultado encontrado para a sua pesquisa.</p>
				</div>
			</div>
		</section>
	</main>

	<!-- Player Modal -->
	<div id="playerModal" class="player-modal hidden">
		<div class="modal-overlay"></div>
		
		<button id="prevMedia" class="nav-btn prev" aria-label="Anterior">
			<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
		</button>
		
		<div class="modal-content">
			<button class="close-modal" aria-label="Fechar">&times;</button>
			<div id="playerContainer" class="player-container">
				<!-- Player or Album List will be injected here -->
			</div>
			<div class="modal-info">
				<div class="modal-header-info">
					<span id="modalNumber"></span>
					<h2 id="modalTitle"></h2>
				</div>
				<div id="albumTrackList" class="album-track-list hidden">
					<!-- Track list for albums -->
				</div>
				<div class="modal-actions">
					<button id="copyLink" class="btn-small">Copiar Link</button>
				</div>
			</div>
		</div>

		<button id="nextMedia" class="nav-btn next" aria-label="Pr√≥ximo">
			<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
		</button>
	</div>

	<Footer />
</Layout>

<style>
	.livro-page {
		padding-top: 40px;
	}

	.livro-hero {
		padding: 60px 0;
		background: linear-gradient(180deg, var(--bg) 0%, var(--bg-2) 100%);
		text-align: center;
	}

	.livro-hero h1 {
		font-size: clamp(32px, 5vw, 48px);
		margin-top: 0;
		margin-bottom: 16px;
		line-height: 1.1;
		margin-bottom: 2px;
	}

	.eyebrow {
		display: block;
		font-size: 2rem;
		font-weight: 600;
		color: var(--muted);
		text-transform: none;
		letter-spacing: normal;
	}

	.lead {
		color: var(--muted);
		font-size: 1.1rem;
		max-width: 600px;
		margin: 0 auto 40px;
	}

	/* Search & Filters */
	.search-container {
		max-width: 700px;
		margin: 0 auto;
		display: flex;
		flex-direction: column;
		gap: 20px;
	}

	#mediaSearch {
		width: 100%;
		padding: 16px 24px;
		border-radius: 12px;
		border: 1px solid rgba(255,255,255,0.1);
		background: rgba(255,255,255,0.05);
		color: #fff;
		font-size: 1rem;
		font-family: inherit;
		outline: none;
		transition: border-color 0.3s, box-shadow 0.3s;
	}

	#mediaSearch:focus {
		border-color: var(--gold);
		box-shadow: 0 0 0 4px rgba(212, 175, 55, 0.1);
	}

	.controls-bar {
		display: flex;
		justify-content: center;
		align-items: center;
		flex-wrap: wrap;
		gap: 20px;
	}

	.view-toggles {
		display: flex;
		align-items: center;
		gap: 10px;
	}

	.view-toggles {
		display: flex;
		align-items: center;
		gap: 12px;
	}

	.separator {
		color: rgba(255,255,255,0.2);
		font-size: 1.5rem;
		font-weight: 300;
		margin: 0 10px;
	}

	/* Removed .view-btn specific text-only styles as they now duplicate .filter-btn */


	.filters {
		display: flex;
		justify-content: center;
		flex-wrap: wrap;
		gap: 12px;
	}

	.filter-btn {
		background: rgba(255,255,255,0.05);
		border: 1px solid rgba(255,255,255,0.1);
		color: var(--muted);
		padding: 8px 16px;
		border-radius: 8px;
		cursor: pointer;
		font-size: 0.9rem;
		transition: all 0.2s;
	}

	.filter-btn:hover {
		background: rgba(255,255,255,0.1);
	}

	.filter-btn.active {
		background: var(--link);
		color: #fff;
		border-color: var(--link);
	}

	/* Compact Mode */
	.media-grid.compact-mode .card-image {
		display: none;
	}

	/* Grid */
	.media-section {
		padding: 60px 0 100px;
	}

	.media-grid {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
		gap: 24px;
	}

	.media-card {
		background: var(--card);
		border: 1px solid rgba(255,255,255,0.06);
		border-radius: 16px;
		overflow: hidden;
		transition: transform 0.3s, box-shadow 0.3s;
		display: flex;
		flex-direction: column;
	}

	.media-card:hover {
		transform: translateY(-5px);
		box-shadow: 0 12px 24px rgba(0,0,0,0.3);
		border-color: rgba(255,255,255,0.15);
		cursor: pointer;
	}

	.card-image {
		width: 100%;
		aspect-ratio: 1/1;
		background: #111;
		overflow: hidden;
		display: flex;
		align-items: center;
		justify-content: center;
	}

	.card-image img,
	.card-image video {
		width: 100%;
		height: 100%;
		object-fit: cover;
	}

	.thumbnail-video {
		pointer-events: none;
	}

	.placeholder-icon {
		font-size: 3rem;
		opacity: 0.5;
	}

	.media-info {
		padding: 20px;
		display: flex;
		flex-direction: column;
		flex-grow: 1;
	}

	.media-number {
		font-size: 0.8rem;
		color: var(--gold);
		font-weight: 700;
		letter-spacing: 0.05em;
		display: block;
		margin-bottom: 8px;
	}

	.media-title {
		font-size: 0.95rem;
		line-height: 1.4;
		margin-bottom: 20px;
		display: -webkit-box;
		-webkit-line-clamp: 2;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}

	.media-footer {
		display: flex;
		align-items: center;
		justify-content: space-between;
		margin-top: auto;
	}

	.type-badge {
		font-size: 0.75rem;
		padding: 4px 8px;
		border-radius: 6px;
		background: rgba(255,255,255,0.05);
	}

	.type-badge.video { color: #fca5a5; }
	.type-badge.audio { color: #93c5fd; }
	.type-badge.album { color: var(--gold); }

	/* Modal */
	.player-modal {
		position: fixed;
		inset: 0;
		z-index: 1000;
		display: flex;
		align-items: center;
		justify-content: center;
		padding: 2vh;
	}

	.modal-overlay {
		position: absolute;
		inset: 0;
		background: rgba(0,0,0,0.98);
		backdrop-filter: blur(10px);
	}

	.modal-content {
		position: relative;
		background: #000;
		width: 95vw;
		max-width: 1400px;
		height: 95vh;
		max-height: 900px;
		border-radius: 12px;
		overflow: hidden;
		box-shadow: 0 0 60px rgba(0,0,0,1);
		border: 1px solid rgba(255,255,255,0.05);
		display: flex;
		flex-direction: column;
	}

	.nav-btn {
		position: absolute;
		top: 50%;
		transform: translateY(-50%);
		background: rgba(255,255,255,0.05);
		color: #fff;
		border: 1px solid rgba(255,255,255,0.1);
		width: 60px;
		height: 60px;
		border-radius: 50%;
		cursor: pointer;
		z-index: 1010;
		display: flex;
		align-items: center;
		justify-content: center;
		transition: all 0.3s cubic-bezier(0.19, 1, 0.22, 1);
		backdrop-filter: blur(5px);
	}

	.nav-btn:hover {
		background: var(--link);
		border-color: var(--link);
		transform: translateY(-50%) scale(1.1);
	}

	.nav-btn.prev { left: 30px; }
	.nav-btn.next { right: 30px; }

	@media (max-width: 1200px) {
		.nav-btn {
			width: 44px;
			height: 44px;
			background: rgba(0,0,0,0.4);
		}
		.nav-btn.prev { left: 15px; }
		.nav-btn.next { right: 15px; }
	}

	.close-modal {
		position: absolute;
		top: 20px;
		right: 20px;
		background: rgba(0,0,0,0.6);
		color: #fff;
		border: 1px solid rgba(255,255,255,0.1);
		font-size: 20px;
		width: 40px;
		height: 40px;
		border-radius: 50%;
		cursor: pointer;
		z-index: 20;
		display: flex;
		align-items: center;
		justify-content: center;
		transition: all 0.2s;
	}

	.close-modal:hover {
		background: rgba(255,50,50,0.8);
		transform: rotate(90deg);
	}

	.player-container {
		background: #000;
		flex: 1;
		min-height: 0;
		display: flex;
		align-items: center;
		justify-content: center;
		position: relative;
		overflow: hidden;
		padding: 2vh 2vw;
	}

	.player-container :global(video) {
		width: 100%;
		height: 100%;
		object-fit: contain;
		outline: none;
		box-shadow: 0 0 40px rgba(0,0,0,0.5);
	}

	.player-container :global(audio) {
		width: 80%;
		max-width: 600px;
		margin-top: auto;
		margin-bottom: 20px;
		flex-shrink: 0;
	}

	.player-container :global(.audio-wrapper) {
		display: flex;
		flex-direction: column;
		align-items: center;
		justify-content: flex-end;
		width: 100%;
		height: 100%;
	}

	.player-container :global(.audio-cover) {
		flex: 1;
		min-height: 0;
		width: 100%;
		object-fit: contain;
		margin-bottom: 20px;
		margin-top: 20px;
		box-shadow: none;
		max-height: none;
	}

	.player-container :global(.audio-placeholder) {
		flex: 1;
		width: 100%;
		display: flex;
		align-items: center;
		justify-content: center;
		font-size: 5rem;
		color: rgba(255,255,255,0.2);
		margin-bottom: 20px;
		border: 1px dashed rgba(255,255,255,0.1);
		border-radius: 12px;
		margin-top: 20px;
	}

	.modal-info {
		padding: 25px 40px;
		background: rgba(10, 10, 10, 0.8);
		backdrop-filter: blur(20px);
		border-top: 1px solid rgba(255,255,255,0.1);
		flex-shrink: 0;
		position: relative;
		z-index: 5;
	}

	.modal-header-info {
		margin-bottom: 0px;
	}

	#modalNumber {
		color: var(--gold);
		font-weight: 700;
		font-size: 0.75rem;
		text-transform: uppercase;
		letter-spacing: 0.25em;
		display: block;
		margin-bottom: 4px;
	}

	#modalTitle {
		font-size: 1.25rem;
		font-weight: 600;
		margin: 0;
		line-height: 1.3;
		color: #fff;
		letter-spacing: -0.01em;
	}

	/* Album Track List */
	.album-track-list {
		margin-top: 15px;
		border-top: 1px solid rgba(255,255,255,0.05);
		padding-top: 15px;
		max-height: 20vh;
		overflow-y: auto;
		scrollbar-width: thin;
		scrollbar-color: rgba(255,255,255,0.2) transparent;
	}

	.album-track-list::-webkit-scrollbar {
		width: 6px;
	}

	.album-track-list::-webkit-scrollbar-thumb {
		background-color: rgba(255,255,255,0.1);
		border-radius: 3px;
	}

	.album-track-list :global(.track-item) {
		display: flex;
		align-items: center;
		padding: 10px 12px;
		background: rgba(255,255,255,0.02);
		margin-bottom: 6px;
		border-radius: 6px;
		cursor: pointer;
		transition: all 0.2s;
	}

	.album-track-list :global(.track-item:hover) {
		background: rgba(255,255,255,0.06);
	}

	.album-track-list :global(.track-item.active) {
		background: rgba(212, 175, 55, 0.1);
		border-left: 3px solid var(--gold);
	}

	.album-track-list :global(.track-icon) { margin-right: 12px; font-size: 0.9rem; }
	.album-track-list :global(.track-name) { font-size: 0.85rem; }

	.hidden { display: none !important; }

	.modal-actions {
		display: flex;
		justify-content: flex-end;
		margin-top: 12px;
	}

	.btn-small {
		background: rgba(255,255,255,0.05);
		color: var(--muted);
		border: 1px solid rgba(255,255,255,0.1);
		padding: 4px 10px;
		border-radius: 4px;
		font-size: 0.75rem;
		cursor: pointer;
		transition: all 0.2s;
	}

	.btn-small:hover {
		background: rgba(255,255,255,0.1);
		color: #fff;
	}

	@media (max-width: 640px) {
		.media-grid { grid-template-columns: 1fr; }
	}
</style>

<script>
	const searchInput = document.getElementById('mediaSearch') as HTMLInputElement;
	const mediaCards = document.querySelectorAll('.media-card');
	// Select only the filter buttons in the filters group
	const filterBtns = document.querySelectorAll('.filters .filter-btn'); 
	const noResults = document.getElementById('noResults');
	const playerModal = document.getElementById('playerModal');
	const playerContainer = document.getElementById('playerContainer');
	const closeModal = document.querySelector('.close-modal');
	const modalOverlay = document.querySelector('.modal-overlay');
	const modalTitle = document.getElementById('modalTitle');
	const modalNumber = document.getElementById('modalNumber');
	const albumTrackList = document.getElementById('albumTrackList');
	const copyLinkBtn = document.getElementById('copyLink');
	const mediaGrid = document.getElementById('mediaGrid');
	const viewBtns = document.querySelectorAll('.view-btn');

	let currentFilter = 'all';
	let searchQuery = '';
	let currentMediaItem: any = null;
	let currentAlbumTracks: any[] = [];
	let currentTrackIndex = -1;

	const prevBtn = document.getElementById('prevMedia');
	const nextBtn = document.getElementById('nextMedia');

	// Lazy Loading for Videos
	document.addEventListener('DOMContentLoaded', () => {
		const lazyVideos = document.querySelectorAll('video.lazy-video');
		
		if ('IntersectionObserver' in window) {
			const videoObserver = new IntersectionObserver((entries, observer) => {
				entries.forEach((entry: any) => {
					if (entry.isIntersecting) {
						const video = entry.target as HTMLVideoElement;
						if (video.dataset.src) {
							video.src = video.dataset.src;
						}
						video.load();
						video.classList.remove('lazy-video');
						observer.unobserve(video);
					}
				});
			});

			lazyVideos.forEach(video => {
				videoObserver.observe(video);
			});
		} else {
			// Fallback for older browsers
			lazyVideos.forEach(video => {
				const v = video as HTMLVideoElement;
				if (v.dataset.src) v.src = v.dataset.src;
			});
		}
	});

	// View Mode Logic
	viewBtns.forEach(btn => {
		btn.addEventListener('click', () => {
			const view = (btn as HTMLElement).dataset.view;
			viewBtns.forEach(b => b.classList.remove('active'));
			btn.classList.add('active');
			
			if (view === 'compact') {
				mediaGrid?.classList.add('compact-mode');
			} else {
				mediaGrid?.classList.remove('compact-mode');
			}
		});
	});

	// Search & Filter Logic
	function updateResults() {
		let visibleCount = 0;
		mediaCards.forEach((card: any) => {
			const type = card.dataset.type;
			const title = card.dataset.title;
			const id = card.dataset.id;
			
			const matchesType = currentFilter === 'all' || type === currentFilter;
			const matchesSearch = title.includes(searchQuery) || id.includes(searchQuery);
			
			if (matchesType && matchesSearch) {
				card.classList.remove('hidden');
				visibleCount++;
			} else {
				card.classList.add('hidden');
			}
		});
		
		if (visibleCount === 0) {
			noResults?.classList.remove('hidden');
		} else {
			noResults?.classList.add('hidden');
		}
	}

	searchInput?.addEventListener('input', (e) => {
		searchQuery = (e.target as HTMLInputElement).value.toLowerCase();
		updateResults();
	});

	filterBtns.forEach(btn => {
		btn.addEventListener('click', () => {
			filterBtns.forEach(b => b.classList.remove('active'));
			btn.classList.add('active');
			currentFilter = (btn as any).dataset.type;
			updateResults();
		});
	});

	// Player Logic
	function playMedia(filename: string, type: string, cover?: string) {
		const src = filename.startsWith('http') ? filename : `/livro_media/${filename}`;
		
		if (!playerContainer) return;
		playerContainer.innerHTML = ''; 

		if (type === 'video') {
			const video = document.createElement('video');
			video.id = 'activePlayer';
			video.controls = true;
			video.playsInline = true;
			video.setAttribute('webkit-playsinline', 'true');
			video.preload = 'metadata';
			
			// Use source element to provide the type hint which helps some browsers
			const source = document.createElement('source');
			source.src = src;
			source.type = 'video/mp4'; // Most are mp4
			video.appendChild(source);
			
			playerContainer.appendChild(video);
			
			video.addEventListener('ended', handleMediaEnded);
			
			// Standard sequence to initiate playback after user interaction
			video.load();
			video.play().catch(error => {
				console.warn("Playback failed:", error);
			});
		} else {
			const wrapper = document.createElement('div');
			wrapper.className = 'audio-wrapper';
			
			if (cover) {
				const img = document.createElement('img');
				img.src = cover;
				img.className = 'audio-cover';
				img.alt = 'Cover';
				wrapper.appendChild(img);
			} else {
				const placeholder = document.createElement('div');
				placeholder.className = 'audio-placeholder';
				placeholder.textContent = 'üéµ';
				wrapper.appendChild(placeholder);
			}
			
			const audio = document.createElement('audio');
			audio.id = 'activePlayer';
			audio.controls = true;
			
			const source = document.createElement('source');
			source.src = src;
			source.type = 'audio/mpeg';
			audio.appendChild(source);
			
			wrapper.appendChild(audio);
			playerContainer.appendChild(wrapper);
			
			audio.addEventListener('ended', handleMediaEnded);
			audio.load();
			audio.play().catch(() => {});
		}
	}

	function handleMediaEnded() {
		if (currentMediaItem && currentMediaItem.type === 'album') {
			// Play next track in album
			if (currentTrackIndex < currentAlbumTracks.length - 1) {
				const nextTrack = currentAlbumTracks[currentTrackIndex + 1];
				playAlbumTrack(nextTrack, currentTrackIndex + 1);
			}
		} else {
			// Optionally auto-advance to next piece? 
			// User didn't explicitly ask for auto-advance pieces, but it's common.
			// goNextMedia();
		}
	}

	function playAlbumTrack(track: any, index: number) {
		currentTrackIndex = index;
		const tracks = albumTrackList?.querySelectorAll('.track-item');
		tracks?.forEach(t => t.classList.remove('active'));
		tracks?.[index]?.classList.add('active');
		
		// Use track cover or fallback to album cover
		const cover = track.cover || currentMediaItem?.cover;
		playMedia(track.filename, track.type, cover);
		
		// Scroll track into view if needed
		tracks?.[index]?.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
	}

	function openItem(item: any) {
		currentMediaItem = item;
		const { id, title, type } = item;
		
		if (modalTitle) modalTitle.textContent = title;
		if (modalNumber) modalNumber.textContent = `#${id}`;
		
		albumTrackList?.classList.add('hidden');
		if (playerContainer) playerContainer.innerHTML = '';
		
		if (type === 'album') {
			currentAlbumTracks = item.tracks;
			albumTrackList?.classList.remove('hidden');
			if (albumTrackList) {
				albumTrackList.innerHTML = item.tracks.map((track: any, index: number) => `
					<div class="track-item" data-idx="${index}">
						<span class="track-icon">${track.type === 'video' ? 'üì∫' : 'üéµ'}</span>
						<span class="track-name">${track.title}</span>
					</div>
				`).join('');

				const trackElements = albumTrackList.querySelectorAll('.track-item');
				trackElements.forEach(el => {
					el.addEventListener('click', () => {
						const idx = parseInt((el as any).dataset.idx);
						playAlbumTrack(currentAlbumTracks[idx], idx);
					});
				});

				// Play first track
				if (currentAlbumTracks.length > 0) {
					playAlbumTrack(currentAlbumTracks[0], 0);
				}
			}
		} else {
			currentAlbumTracks = [];
			currentTrackIndex = -1;
			playMedia(item.filename, type, item.cover);
		}
		
		playerModal?.classList.remove('hidden');
		document.body.style.overflow = 'hidden';

		// Deep linking
		const url = new URL(window.location.href);
		url.searchParams.set('m', id);
		window.history.pushState(null, '', url.toString());
		
		updateNavButtons();
	}

	function updateNavButtons() {
		if (!currentMediaItem) return;
		
		const visibleCards = Array.from(document.querySelectorAll('.media-card:not(.hidden)'));
		const currentIndex = visibleCards.findIndex((card: any) => card.dataset.id === String(currentMediaItem.id));
		
		if (prevBtn) (prevBtn as any).style.display = currentIndex > 0 ? 'flex' : 'none';
		if (nextBtn) (nextBtn as any).style.display = currentIndex < visibleCards.length - 1 ? 'flex' : 'none';
	}

	function goPrevMedia() {
		const visibleCards = Array.from(document.querySelectorAll('.media-card:not(.hidden)'));
		const currentIndex = visibleCards.findIndex((card: any) => card.dataset.id === String(currentMediaItem.id));
		if (currentIndex > 0) {
			const prevCard = visibleCards[currentIndex - 1] as HTMLElement;
			const item = JSON.parse(prevCard.querySelector('.media-data')?.getAttribute('data-item') || '{}');
			openItem(item);
		}
	}

	function goNextMedia() {
		const visibleCards = Array.from(document.querySelectorAll('.media-card:not(.hidden)'));
		const currentIndex = visibleCards.findIndex((card: any) => card.dataset.id === String(currentMediaItem.id));
		if (currentIndex < visibleCards.length - 1) {
			const nextCard = visibleCards[currentIndex + 1] as HTMLElement;
			const item = JSON.parse(nextCard.querySelector('.media-data')?.getAttribute('data-item') || '{}');
			openItem(item);
		}
	}

	prevBtn?.addEventListener('click', (e) => {
		e.stopPropagation();
		goPrevMedia();
	});
	
	nextBtn?.addEventListener('click', (e) => {
		e.stopPropagation();
		goNextMedia();
	});

	// Keyboard Navigation
	document.addEventListener('keydown', (e) => {
		if (playerModal?.classList.contains('hidden')) return;
		
		if (e.key === 'ArrowLeft') goPrevMedia();
		if (e.key === 'ArrowRight') goNextMedia();
		if (e.key === 'Escape') closePlayer();
	});

	function closePlayer() {
		playerModal?.classList.add('hidden');
		if (playerContainer) playerContainer.innerHTML = '';
		currentMediaItem = null;
		document.body.style.overflow = '';
		
		const url = new URL(window.location.href);
		url.searchParams.delete('m');
		window.history.pushState(null, '', url.toString());
	}

	document.body.addEventListener('click', (e) => {
		// Only trigger if clicking a media card, but prevent double triggering if clicking internal clickable elements if any exist
		const card = (e.target as Element).closest('.media-card');
		if (card) {
			const dataSpan = card.querySelector('.media-data');
			if (dataSpan) {
				const item = JSON.parse((dataSpan as any).dataset.item);
				openItem(item);
			}
		}
	});

	closeModal?.addEventListener('click', closePlayer);
	modalOverlay?.addEventListener('click', closePlayer);

	// Handle URL params on load
	window.addEventListener('load', () => {
		const params = new URLSearchParams(window.location.search);
		const mediaId = params.get('m');
		if (mediaId) {
			const card = document.querySelector(`.media-card[data-id="${mediaId}"]`);
			if (card) {
				const item = JSON.parse(card.querySelector('.media-data')?.getAttribute('data-item') || '{}');
				openItem(item);
				card.scrollIntoView({ behavior: 'smooth', block: 'center' });
			}
		}
	});

	// Copy Link
	copyLinkBtn?.addEventListener('click', () => {
		navigator.clipboard.writeText(window.location.href).then(() => {
			const originalText = copyLinkBtn.textContent;
			copyLinkBtn.textContent = 'Copiado!';
			setTimeout(() => { copyLinkBtn.textContent = originalText; }, 2000);
		});
	});
</script>
